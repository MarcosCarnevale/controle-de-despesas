<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastrar Pagamento</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles_pagamentos.css') }}">
</head>
<body>
    <div class="d-flex vh-100">
        <div class="sidebar bg-dark text-white p-3">
            <h2>Menu</h2>
            <ul class="list-unstyled">
                <li><a href="{{ url_for('auth.home') }}" class="text-white">Início</a></li>
                <li><a href="{{ url_for('pagamento.cadastrar_pagamento') }}" class="text-white">Cadastrar Pagamento</a></li>
                <li><a href="{{ url_for('banco.cadastrar_banco') }}" class="text-white">Cadastrar Banco</a></li>
                <li><a href="{{ url_for('categoria.cadastrar_categoria') }}" class="text-white">Cadastrar Categoria</a></li>
                <li><a href="{{ url_for('cartao.cadastrar_cartao') }}" class="text-white">Cadastrar Cartão</a></li>
                <li>
                    <form action="{{ url_for('auth.logout') }}" method="post" style="display: inline;">
                        <input type="submit" value="Logout" class="btn btn-link text-white p-0">
                    </form>
                </li>
            </ul>
        </div>
        <div class="content-wrapper flex-grow-1 p-3 overflow-auto">
            <div class="content">
                <h1>Cadastrar Pagamento</h1>
                <div class="actions d-flex justify-content-between mb-3">
                    <button class="btn btn-primary" onclick="openModal()">+ Adicionar</button>
                    <div>
                        <button class="btn btn-danger" onclick="apagarSelecao()">Apagar Seleção</button>
                        <button class="btn btn-success" onclick="pagarSelecao()">Pagar Seleção</button>
                    </div>
                    <select class="form-control w-auto">
                        <option value="data_recente">Data mais recente</option>
                        <option value="data_antiga">Data mais antiga</option>
                        <option value="maior_valor">Maior valor</option>
                        <option value="menor_valor">Menor valor</option>
                        <option value="descricao">Descrição</option>
                    </select>
                </div>

                <div class="table-container">
                    <h2>Pagamentos Cadastrados</h2>
                    <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Data</th>
                                    <th>Categoria</th>
                                    <th>Subcategoria</th>
                                    <th>Banco</th>
                                    <th>Parcela</th>
                                    <th>Quantidade de Parcelas</th>
                                    <th>Cartão</th>
                                    <th>Status Pagamento</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for pagamento in pagamentos %}
                                <tr data-id="{{ pagamento[0] }}">
                                    <td><input type="checkbox" class="select-item" value="{{ pagamento[0] }}"></td>
                                    <td>{{ pagamento[1] }}</td>
                                    <td class="valor">{{ pagamento[2] }}</td>
                                    <td>{{ pagamento[3] }}</td>
                                    <td>{{ pagamento[4] }}</td>
                                    <td>{{ pagamento[5] if pagamento[5] is not none else '' }}</td>
                                    <td class="banco">{{ pagamento[6] }}</td>
                                    <td>{{ pagamento[7] if pagamento[7] is not none else '' }}</td>
                                    <td>{{ pagamento[8] if pagamento[8] is not none else '' }}</td>
                                    <td>{{ pagamento[9] if pagamento[9] is not none else '' }}</td>
                                    <td>{{ pagamento[10] }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-success" onclick="atualizarStatus({{ pagamento[0] }}, 'Pago')" title="Pagar conta">
                                            <i class="fas fa-check"></i>
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="atualizarStatus({{ pagamento[0] }}, 'Em Aberto')" title="Abrir conta">
                                            <i class="fas fa-undo"></i>
                                        </button>
                                        <a href="{{ url_for('pagamento.editar_pagamento', id=pagamento[0]) }}" class="btn btn-sm btn-warning" title="Editar">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <form action="{{ url_for('pagamento.excluir_pagamento', id=pagamento[0]) }}" method="post" style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Excluir" onclick="return confirm('Tem certeza que deseja excluir este pagamento?');">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </form>
                                        <button class="btn btn-sm btn-info" onclick="document.getElementById('fileInput{{ pagamento[0] }}').click()" title="Anexar Arquivo">
                                            <i class="fas fa-paperclip"></i>
                                        </button>
                                        <form action="{{ url_for('pagamento.salvar_anexo') }}" method="post" enctype="multipart/form-data" style="display:inline;">
                                            <input type="hidden" name="pagamento_id" value="{{ pagamento[0] }}">
                                            <input type="file" id="fileInput{{ pagamento[0] }}" name="arquivo" style="display: none;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png" onchange="salvarAnexo(event, {{ pagamento[0] }})">
                                        </form>
                                        {% if pagamento[11] %}
                                        <a href="{{ url_for('pagamento.download_anexo', id=pagamento[0]) }}" class="btn btn-sm btn-primary" title="Baixar Anexo">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <form action="{{ url_for('pagamento.apagar_anexo', id=pagamento[0]) }}" method="post" style="display:inline;">
                                            <button type="submit" class="btn btn-sm btn-danger" title="Apagar Anexo" onclick="return confirm('Tem certeza que deseja apagar este anexo?');">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cadastrar Pagamento</h5>
                    <button type="button" class="close" onclick="closeModal()" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="cadastroPagamentoForm" action="{{ url_for('pagamento.cadastrar_pagamento') }}" method="post">
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="descricao">Descrição</label>
                                <input type="text" id="descricao" name="descricao" class="form-control" placeholder="Digite a descrição" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="valor">Valor</label>
                                <input type="number" id="valor" name="valor" class="form-control" placeholder="Digite o valor" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="data">Data</label>
                                <input type="date" id="data" name="data" class="form-control" required>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="categoria">Categoria</label>
                                <select id="categoria" name="categoria" class="form-control" required onchange="updateSubcategorias()">
                                    <option value="">Selecione uma categoria</option>
                                    {% for categoria in categorias %}
                                        <option value="{{ categoria[0] }}">{{ categoria[0] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="subcategoria">Subcategoria</label>
                                <select id="subcategoria" name="subcategoria" class="form-control" required>
                                    <option value="">Selecione uma subcategoria</option>
                                </select>
                            </div>
                            <div class="form-group col-md-6">
                                <label for="banco">Banco</label>
                                <select id="banco" name="banco" class="form-control">
                                    <option value="">Selecione um banco</option>
                                    {% for banco in bancos %}
                                        <option value="{{ banco[1] }}">{{ banco[1] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-6">
                                <label for="parcela">Parcela</label>
                                <div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" id="parcela_sim" name="parcela" value="sim" class="form-check-input" required onclick="toggleParcelaFields(true)">
                                        <label for="parcela_sim" class="form-check-label">Sim</label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input type="radio" id="parcela_nao" name="parcela" value="nao" class="form-check-input" required checked onclick="toggleParcelaFields(false)">
                                        <label for="parcela_nao" class="form-check-label">Não</label>
                                    </div>
                                </div>
                            </div>
                            <div id="parcelaFields" class="form-group col-md-6" style="display: none;">
                                <label for="quantidade_parcelas">Quantidade de Parcelas</label>
                                <input type="number" id="quantidade_parcelas" name="quantidade_parcelas" class="form-control" placeholder="Digite a quantidade de parcelas">
                                <label for="cartao">Cartão</label>
                                <select id="cartao" name="cartao" class="form-control">
                                    <option value="">Selecione um cartão</option>
                                    {% for cartao in cartoes %}
                                        <option value="{{ cartao }}">{{ cartao }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Fechar</button>
                            <input type="submit" class="btn btn-primary" value="Cadastrar">
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='scripts/cadastrar_pagamento.js') }}"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>